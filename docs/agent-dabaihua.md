# 大白话聊聊 Agent 是啥

## Agent 的基本想法
- 可以把 Agent 想成「会自己找工具干活的小助理」。  
- 它会先听你说什么，再自己琢磨要做啥，然后去翻资料、点工具、回报结果。  
- 跟普通聊天机器人不一样，它能调用“外部能力”，比如搜索文档、跑浏览器、写文件。

## Agent 干活的四步曲
1. **感知**：读你的指令、看上下文、查附件——明白现在要解决的问题。  
2. **思考**：决定方案，是否需要拆步骤、有没有现成经验可复用。  
3. **行动**：调用工具（查知识库、跑脚本、控浏览器等），必要时多轮执行。  
4. **记忆**：把结果、心得存起来，下次遇到类似任务可以少走弯路。

## 为什么要用 Agent
- **复杂任务自动化**：像“帮我做竞品调研并写总结”这种多步骤活儿，人手动切工具很累，Agent 可以串联。  
- **知识复用**：它能先搜历史 SOP/经验，再开始执行，避免重复发明轮子。  
- **可观测可控**：每次调用什么工具、进度到哪儿，都能在日志或前端流式界面看到，便于审计和纠错。

## 一个具体例子
> 需求：给我整理一家公司的技术栈，并输出一张对比表。

Agent 可能这么做：
1. 先用「技能检索」找有没有“技术栈调研”模板。  
2. 如果任务复杂，会先调用 todo 工具拆成“收集信息 / 验证 / 写表格”三步。  
3. 用浏览器工具打开官网、GitHub、新闻页面收集资料。  
4. 把整理好的 Markdown 表格写进 Acontext 磁盘，让你下载或继续编辑。  
5. 最后汇报成果并记录经验，下次调研类似公司就更快。

## 和传统自动化的区别
- 不需要提前把流程写死，Agent 可以结合上下文动态决定步骤。  
- 遇到不确定的情况会补问或改方案，而不是直接失败。  
- 通过记忆（像 Acontext 这样的“脑外存”）积累知识，越用越聪明。

## 入门建议
- 先从“可观察”的工具开始，比如知识库搜索、todo 规划、浏览器自动化。  
- 给 Agent 清晰边界：能用哪些工具、文件存放在哪、需要遵守的流程。  
- 多看它的工具日志，逐步补充 SOP 或限制条件，让行为更可控。

---

## 一页看懂本项目架构（做 PPT 可直接用）
- 前端：Next.js + App Router，SSE 流式展示模型回复与工具进度。  
- 后端：Next API Routes 承载聊天与工具编排，OpenAI Chat Completions 做 LLM 推理。  
- 工具层：  
  - 经验搜索：从 Acontext Space 里检索 SOP/技能，确保“先复用经验再行动”。  
  - Todo 拆解：遇到复杂任务先列步骤，减少走弯路。  
  - 浏览器自动化：云端 Browser Use，能打开网页、点击、抓数据。  
  - 磁盘工具：基于 Acontext Disk 读/写/替换/列举/下载文件。  
- 存储：Acontext 负责 Session/消息/Disk/Space，Supabase 只存用户映射和最小元数据。  
- 记忆：Acontext Space 累积 SOP 与经验；Session 存对话；Disk 存附件与产物。

## 流程拆解（可画流程泳道图）
1) 用户发请求 → API 校验用户、过滤可用工具。  
2) 取历史消息 + 自动做“上下文压缩”（防 token 爆炸）。  
3) 拼系统提示：强制“先经验搜索，再工具；复杂任务先 todo”。  
4) LLM 进入工具循环：  
   - 第一次优先调用经验搜索；若任务大，调用 todo 拆步骤。  
   - 按计划多轮调用浏览器/磁盘等工具，边做边写入对话。  
   - 无工具调用时输出最终答复。  
5) 把回复、工具结果落回 Acontext，前端 SSE 同步展示。

## 核心卖点（PPT 可单独成页）
- 工作流硬约束：强制“经验优先 + 规划优先”，降低瞎跑。  
- 长期记忆：SOP/技能存 Space，附件/产物存 Disk，对话存 Session。  
- 可观测：工具开始/步骤/完成流式输出，方便审计和复盘。  
- 可扩展：新增工具只需写 schema + executor，自动进入 LLM 循环。  
- 守护安全：用户鉴权、工具白名单、配置缺失降级、超时保护。

## 关键技术点
- **工具循环**：基于 OpenAI 的 function calling，多轮调用直到没有 tool_calls。  
- **上下文压缩策略**：超过阈值时，自动删旧的工具结果/参数或限高 token。  
- **浏览器自动化**：云端 Browser Use，支持同步/流式两种模式，整体 5 分钟超时。  
- **Acontext 集成**：直接创建 Session/Disk；Space 用来存 SOP；提供磁盘读写工具给 Agent。  
- **权限与降级**：Supabase 鉴权；缺少 API Key 时工具自动禁用并给出友好提示。  
- **流式体验**：SSE 输出 token、工具进度、最终消息，前端实时渲染。

## 更细的技术拆解
- **LLM 配置**：OpenAI gpt-4o/4.1；Top_p 适中防止过度发散；工具调用温度可更高以探索步骤，最终回答温度较低保证稳。  
- **工具选择逻辑**（系统提示约束 + 代码护栏）：  
  1) 首次回复必须优先 `经验搜索`；  
  2) 若回复里包含“复杂/多步骤”则必须调用 `todo`；  
  3) 浏览器/磁盘工具需在白名单且具备凭据；  
  4) 每次 tool 调用后把结果写回对话，方便后续引用。  
- **记忆压缩策略**：  
  - 按优先级丢弃：旧的工具结果摘要 < 旧的用户闲聊 < 最新指令。  
  - 压缩形式：只保留结论 + 关键参数（如 URL、选取的 DOM），去掉冗长正文。  
  - 触发阈值：消息 tokens 超过设定值自动触发；也可在系统提示中主动要求“先压缩再继续”。  
  - 失败兜底：压缩后仍超限，则只保留最新几轮对话和最终计划摘要。  
- **工具实现示例**：  
  - `经验搜索`：输入 query，调用 Acontext Space 搜索，返回命中文档的标题+摘要+链接。  
  - `todo`：输入任务描述，输出 JSON 步骤；后续消息可引用这些步骤。  
  - `浏览器`：输入 URL + 动作脚本（点击/填写/等待选择器），返回页面片段或截图链接。  
  - `磁盘读写`：基于 Acontext Disk，支持 list/read/write/patch，路径受限在指定目录。  
  - `下载提供`：写完文件给出下载链接或路径，便于用户取走。  
- **安全与稳健性**：  
  - 工具白名单 + 参数校验（URL 必须 http/https；写文件限制在工作目录）。  
  - 超时控制：单次浏览器 5 分钟，整体对话可配置软/硬超时。  
  - 错误提示：工具异常要把错误信息总结给用户，并建议缩小范围或补充信息。  
- **观测与日志**：  
  - 所有 tool_calls 记录时间、输入、输出摘要。  
  - SSE 事件区分：token、工具开始、工具输出、最终消息，便于前端渲染进度。  
  - 便于审计：可以复盘哪次调用了哪个工具、用的参数、得到的结果。

## 如何在 PPT 展示“技术栈”
- “前端”：Next.js + SSE；展示消息流示意。  
- “后端”：Next API + OpenAI + 工具编排；画出工具循环框图。  
- “工具层”：经验搜索 / todo / 浏览器 / 磁盘；用图标列举。  
- “存储层”：Acontext（Session/Space/Disk）+ Supabase（Auth + 索引）。  
- “守护与观测”：超时、白名单、日志、token 计数。

## 场景示例（可做两页）
- 调研报告：技能检索模板 → todo 拆解 → 浏览器抓数据 → 磁盘写 Markdown → 汇报。  
- 代码/文档处理：读取磁盘文件 → 生成改写稿 → 写回磁盘 → 提供下载链接。  
- SOP 积累：完成一次任务后，把关键步骤存成技能块，下次经验搜索直接命中。

## 风险与对策（PPT 尾页做“防坑”）
- 模型瞎调工具：用系统提示强制顺序 + 工具白名单。  
- 上下文爆炸：启用自动压缩，必要时手动触发更激进压缩。  
- 外部依赖失效：缺 Key/接口超时时友好降级，提示用户处理。  
- 浏览器自动化不稳定：设超时，提示用户缩小任务或改为手动步骤。  
- 数据落地不一致：全部写入 Acontext，Supabase 只做索引，避免双写。

## 给演示准备的“套路”
- 现场跑一个“竞品调研”或“网站信息提取”示例，边跑边展示 SSE 工具进度。  
- 打开 Acontext 磁盘查看产物文件，展示“记忆”落地。  
- 展示一次经验搜索命中历史 SOP，体现“越用越聪明”。

